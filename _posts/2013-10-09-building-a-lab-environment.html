---
layout: post
title: Building a lab environment
date: 2013-10-09 20:55:04.000000000 +01:00
categories:
- Infrastructure
- Windows
tags:
- Hyper-V
- Server 2008
- Server 2012
- Windows
status: private
type: post
published: false
meta:
  _edit_last: '20508111'
  publicize_linkedin_url: http://www.linkedin.com/updates?discuss=&scope=20952117&stype=M&topic=5793810687323013120&type=U&a=P40m
  publicize_twitter_user: garfieldmoore
  publicize_twitter_url: http://t.co/9J78BJ3Lpy
  _wpas_done_4780980: '1'
  _publicize_done_external: a:1:{s:7:"twitter";a:1:{i:20430620;b:1;}}
  _wpas_done_4781430: '1'
  _wpas_skip_4780980: '1'
  _wpas_skip_4781430: '1'
  geo_public: '0'
author:
  login: garfieldmoore
  email: garfieldmoore@gmail.com
  display_name: Garfield Moore
  first_name: ''
  last_name: ''
excerpt: !ruby/object:Hpricot::Doc
  options: {}
---
<p>I've been building a lab environment in Hyper-V and thought it would be interesting to write up my experience over a few blog posts.</p>
<p>My goal was to install a Sql Server cluster.  After a bit of investigation I came up with the below network design;</p>
<p>[caption id="attachment_295" align="aligncenter" width="131"]<a href="http://garfieldmoore.files.wordpress.com/2013/10/basiclabenv.jpg"><img class="size-medium wp-image-295" alt="Initial lab" src="assets/basiclabenv.jpg?w=131" width="131" height="196" /></a> Initial lab[/caption]</p>
<p>MS Sql Server needs to be installed on a server with windows fail-over configured for clustering.  Windows Fail-over can only be configured on a server in a domain.</p>
<p>So we'll need to create 3 virtual machines, configuring one as a domain controller and join the other two to the domain we create.  </p>
<p>I've also included another server to configure as an ISCSI device so the clustered servers can have shared storage (a future blog post).  For now, we'll just concentrate on the 3 networked servers.</p>
<p><strong>Creating a domain controller</strong></p>
<p lang="en-GB">Create a virtual machine called acme-dc and install Windows Server 2012.</p>
<p lang="en-GB">In hyper-v, open the virtual network manager</p>
<p lang="en-GB">Create a new virtual network . Call it  'acme internal' and set the connection type to 'internal only'.</p>
<p lang="en-GB">Once windows has installed, turn off the virtual machine, right click and select 'Settings...'</p>
<p lang="en-GB">In the settings dialog, select network adapter and add the 'acme internal' from the network list</p>
<p lang="en-GB">Start and connect to the virtual machine</p>
<p lang="en-GB">Hyper-v doesn't set the machine name to the one you gave the VM.  To see this type hostname at a command prompt and press enter.</p>
<p lang="en-GB">There are a number of ways we can rename the computer.  I prefer to do this in the power-shell command window;</p>
<pre>netdom /renamecomputer [machinename] /newname:acme-dc</pre>
<p lang="en-GB">Now we need to make this machine a domain controller.  To do this we need to add AD the Domain services role</p>
<p lang="en-GB">Open the server manager, select the manage menu and select 'Add roles and features'</p>
<p lang="en-GB">Select role based and click next. Click next on the following screen. Then select 'Active Directory Domain Services' on the roles screen and click next until you reach the install screen.  Select install.</p>
<p lang="en-GB">Once installed it should give you the option to 'promote server to domain controller' in the server manager dashboard.</p>
<p lang="en-GB">Now all we need to do is add a new forest called acme.com.</p>
<p lang="en-GB">This is done in the  'Active Directory Domains and Trusts' dialog from the server managers tools menu</p>
<p lang="en-GB"><strong>Setting a static IP</strong></p>
<p lang="en-GB">Before we add other servers to our network we'll need to give this server a static IP address.</p>
<p lang="en-GB">To do this open the network and sharing centre, click change adapter settings.This brings up a dialog that should have one adapter. rename this to 'internal'. Right click on the adapter and select properties.</p>
<p lang="en-GB">Find the IPv4 settings in the list and double click.  In the properties dialog, select 'Use the following IP address' and enter 10.10.0.1</p>
<p lang="en-GB">[TAB] past subnet and default gateway and select 'use the following DNS server address'. Enter 127.0.0.1.</p>
<p lang="en-GB">Click the ok button to save these settings, confirm the other dialogs and close network and sharing centre.</p>
<p lang="en-GB">We should now be able to ping ourselves by host name, localhost and ip address (use ping -4 to force the use of ipv4)</p>
<p><strong>Add a new server to the domain</strong></p>
<p lang="en-GB">Create a virtual machine called acme-svr-001 and install Windows Server 2012. You will need to install the enterprise or data-centre editions if you want to cluster these.</p>
<p lang="en-GB">Once windows has installed, turn off the virtual machine, right click and select 'Settings...'</p>
<p lang="en-GB">In the settings dialog, select network adapter and add the 'acme internal' from the network list</p>
<p lang="en-GB">Start and connect to the virtual machine</p>
<p lang="en-GB">Rename the computer as before; Open a powershell command window and type the following command;</p>
<pre>netdom /renamecomputer [machinename] /newname:acme-svr-001</pre>
<p lang="en-GB"><strong>Configure dns server</strong></p>
<p lang="en-GB">We'll give this a static IP again and configure the DNS server to be the domain controller;</p>
<p lang="en-GB">Open network and configure the server to have a static IP (10.10.0.x)</p>
<p lang="en-GB">Set the preferred dns server to the domain controllers IP address (10.10.0.1)</p>
<p lang="en-GB">Open a powershell command window to confirm you can ping the domain controller by IP and it's host name acme-dc</p>
<p lang="en-GB">Turn off windows firewall (this makes it easier to avoid firewall issues and this is only a lab)</p>
<p lang="en-GB"><strong>Joining the domain</strong></p>
<p lang="en-GB">Go back to server manager, select local computer and choose the workgroup link.</p>
<p lang="en-GB">This opens system properties.  Now click 'change'.</p>
<p lang="en-GB">Change the 'member of' from workgroup to domain and enter acme.com into the domain field.</p>
<p lang="en-GB">Click ok and it should confirm you have joined the domain.</p>
<p lang="en-GB">If it fails it is either a firewall or networking issue.  If it isn't a firewall issue check the IP addresses you configured and the network adapters added in the virtual machines settings.</p>
<p lang="en-GB">Breath a sigh of relief and repeat this for the number of servers you want in your network.</p>
<p><strong>Conclusion</strong></p>
<p>We now have a domain controller and a number of servers that are on the same network and in the same domain.  In a future post I'll install windows failover and sql server clustering to finish my lab environment.</p>
